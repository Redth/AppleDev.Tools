name: Run iOS Simulator

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  run:
    name: Run
    runs-on: macos-latest
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
    - name: üõ†Ô∏è Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '26.2'
    - name: ‚öôÔ∏è Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 10.0.x
    - name: üì¶ Install iOS workload
      run: dotnet workload install ios --source https://api.nuget.org/v3/index.json
    - name: üî® Build the project
      run: GITHUB_ENV=/dev/null dotnet build AppleDev.Tool/AppleDev.Tool.csproj

    - name: üìã List available simulators
      run: dotnet run --no-launch-profile --project AppleDev.Tool -- simulator list

    - name: üÜï Create and boot simulator
      run: |
        RESULT=$(dotnet run --no-launch-profile --project AppleDev.Tool -- simulator create "E2ETestSim" --device-type "iPhone 16" --boot --wait --format json)
        echo "Simulator create result: $RESULT"
        UDID=$(echo "$RESULT" | jq -r '.udid')
        if [ -z "$UDID" ] || [ "$UDID" = "null" ]; then
          echo "‚ùå Failed to parse UDID from simulator create output"
          exit 1
        fi
        echo "‚úÖ UDID: $UDID"
        echo "--- Verifying simulator exists and is booted ---"
        STATE=$(xcrun simctl list devices -j | jq -r ".devices[][] | select(.udid == \"$UDID\") | .state")
        if [ "$STATE" != "Booted" ]; then
          echo "‚ùå Simulator state is '$STATE', expected 'Booted'"
          xcrun simctl list devices | grep -A1 "E2ETestSim" || true
          exit 1
        fi
        echo "‚úÖ Simulator $UDID is Booted"

    - name: üì± Create test iOS app
      run: |
        dotnet new ios -n TestApp --output TestApp
        sed -i.bak 's/return true;/System.Console.WriteLine("TestApp: E2E_APP_STARTED_SUCCESSFULLY"); return true;/' TestApp/AppDelegate.cs
        dotnet build TestApp/TestApp.csproj -f net10.0-ios -c Release -r iossimulator-arm64
        APP_PATH=$(find TestApp -name "TestApp.app" -path "*/bin/*" | head -1)
        if [ -z "$APP_PATH" ]; then
          echo "‚ùå Could not find TestApp.app after build"
          exit 1
        fi
        echo "‚úÖ App built: $APP_PATH"

    - name: üì¶ Install and verify app on simulator
      run: |
        APP_PATH=$(find TestApp -name "TestApp.app" -path "*/bin/*" | head -1)
        echo "Installing app: $APP_PATH"
        dotnet run --no-launch-profile --project AppleDev.Tool -- simulator app install "E2ETestSim" --path "$APP_PATH"
        echo "--- Verifying app is installed ---"
        if ! xcrun simctl listapps E2ETestSim 2>/dev/null | grep -q "com.companyname.testapp"; then
          echo "‚ö†Ô∏è Could not verify via listapps, checking with get_app_container"
          if ! xcrun simctl get_app_container E2ETestSim com.companyname.testapp 2>/dev/null; then
            echo "‚ùå App not found on simulator after install"
            exit 1
          fi
        fi
        echo "‚úÖ App installed on simulator"

    - name: üöÄ Launch test app
      run: |
        dotnet run --no-launch-profile --project AppleDev.Tool -- simulator app launch "E2ETestSim" --bundle-id com.companyname.testapp
        sleep 10

    - name: üìã Capture and verify logs
      timeout-minutes: 2
      run: |
        timeout 30 dotnet run --no-launch-profile --project AppleDev.Tool -- simulator logs "E2ETestSim" --format text > simulator-logs.txt 2>&1 || true
        if [ ! -f simulator-logs.txt ] || [ ! -s simulator-logs.txt ]; then
          echo "‚ùå simulator-logs.txt was not created or is empty"
          exit 1
        fi
        echo "--- Log output (last 30 lines) ---"
        tail -30 simulator-logs.txt
        echo "--- Checking for app log marker ---"
        if ! grep -q "E2E_APP_STARTED_SUCCESSFULLY" simulator-logs.txt; then
          echo "‚ùå App log marker 'E2E_APP_STARTED_SUCCESSFULLY' not found in logs"
          exit 1
        fi
        echo "‚úÖ App ran real code successfully"

    - name: üßπ Cleanup simulator
      if: always()
      run: dotnet run --no-launch-profile --project AppleDev.Tool -- simulator delete --force "E2ETestSim"

    - name: üì§ Upload logs
      if: always()
      uses: actions/upload-artifact@v5
      with:
        name: simulator-logs
        path: simulator-logs.txt
        if-no-files-found: ignore
